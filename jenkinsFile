/*
## PLUGINS
---
Allure Jenkins plugin
Build Pipeline plugin
Build With Parameters plugin
Build Discard plugin
Copy Artifact plugin
Delivery Pipeline plugin
Email Extension plugin
Pipeline plugin
Simple Theme plugin
Test Results Analyzer plugin

## JENKINS SCHEME
---
http://afonsof.com/jenkins-material-theme/dist/material-light.css
*/

pipeline {

    agent any

    options {
        buildDiscarder(logRotator(numToKeepStr: '10'))
    }

    stages {
    stage('Polling Scm') {
                steps {
                    echo 'Polling Scm changes...'
                    git url: 'https://github.com/klindziukp/automation-portal.git', branch: 'AP-11-migrate-to-SQL'
                }
            }
    stage('Compile') {
                steps {
                    echo 'Compiling...'
                    gradlew('clean', 'classes')
                }
            }
    stage('Unit Tests') {
                steps {
                    echo 'Perform unit testing...'
                    gradlew('test -i')
                }
            }
     stage('Assemble') {
                 steps {
                     echo 'Assembling build analysis...'
                     gradlew('assemble')
                     stash includes: '**/build/libs/*.jar', name: 'automation-portal'
                 }
             }
      stage('Archive artifacts') {
            steps {
                echo 'Archive artifacts...'
                archiveArtifacts artifacts: '**/build/libs/*.jar', fingerprint: true, onlyIfSuccessful: true
            }
        }
    }
  }

post {
        success {
          // publish html
          publishHTML target: [
              allowMissing: false,
              alwaysLinkToLastBuild: false,
              keepAll: true,
              reportDir: '**/build/test-results/report',
              reportFiles: 'index.html',
              reportName: 'RCov Report'
            ]
        }
      }
    }
  }

def gradlew(String... args) {
    sh "./gradlew ${args.join(' ')} -s"
}